
  <!-- Main Header -->
  <include file="Public:header" title="商品分类管理" />
  <!--Main Sidebar-->
  <include file="Public:left_nav" />

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <ol class="breadcrumb">
        <li><a href="/index.php/Admin/Index.html"><i class="fa fa-home"></i> 首页</a></li>
        <li class="active">分类管理</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <!-- Your Page Content Here -->
      <div class="row">
        <div class="col-md-3">
          <div class="box box-primary">
            <div class="box-header with-border">
              <!-- <h3 class="box-title">校区列表</h3> -->
              <div class="form-group" style="margin-bottom: 0;">
                <button type="button" class="btn btn-success btn-sm cate_add">
                  <i class="fa fa-plus"></i> 添加商品分类
                </button>
              </div>
            </div>
            <div class="box-body">
              <div class="tree-search">
                <i class="tree-search-icon" id="searchNodeBtn"></i> 
                <input type="text" placeholder="搜索" id="searchNodeVal" value="" class="empty fs-12" />
              </div>
              <div class="tree-scroll">
                <ul id="treeLei" class="ztree"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-9">
          <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#tab1" data-toggle="tab">商品分类管理</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="tab1">
                <!-- table -->
                <div class="content-wrap">
                  <div class="row">
                    <div class="col-md-12">
                      <div id="toolbar">
                        <div id="remove" class="btn btn-danger btn-sm" style="margin-top:12px">
                          <i class="fa fa-trash"></i> 删除
                        </div>
                        <div class="btn btn-success btn-sm sub_cate_add" style="margin-top:12px">
                          <i class="fa fa-plus"></i> 添加子分类
                        </div>
                      </div>
                      <table id="table_data" class="js-custom-table-data">
                        <thead>
                          <tr>
                            <th data-field="state" data-checkbox="true"></th>
                            <th data-align="center" data-formatter="editFormatter" data-events="operateEvents" name="editFormatter">操作</th>
                            <th data-align="center" data-sortable="false" data-field="name" name="">子分类名称</th>
                          </tr>
                        </thead>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- /.tab-content -->
          </div>
          <!-- /.nav-tabs-custom -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <include file="Public:footer" />

</div>
<!-- ./wrapper -->

<!-- 商品分类 编辑/添加 弹出层 -->
<div class="shade" style="" id="cate_modalWindow">
  <div class="modal-body">
    <div class="container-fluid">
      <form class="form-horizontal" action="" method="post" onsubmit="return false" id="cate_formWindow">
        <div class="row">
          <div class="col-md-12">
            <div class="clearfix">
              <p class="note pull-right">注：<span class="xing">*</span>标记为必填项</p>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label class="col-md-3 control-label" for="name"><span class="xing">*</span> 商品分类名称：</label>
                  <div class="col-md-8">
                    <input type="text" id="cate_name" name="name" class="form-control" placeholder="商品分类名称" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-footer" style="text-align:center;">
    <button type="button" class="btn btn-success btn-sm save">
      <span class="glyphicon glyphicon-save"></span> 保存
    </button>
    <button type="button" class="btn btn-default btn-sm layui-layer-close">
      <span class="glyphicon glyphicon-remove"></span> 取消
    </button>
  </div>
</div>

<!-- 商品子分类 编辑/添加 弹出层 -->
<div class="shade" style="" id="sub_cate_modalWindow">
  <div class="modal-body">
    <div class="container-fluid">
      <form class="form-horizontal" action="" method="post" onsubmit="return false" id="sub_cate_formWindow">
        <input type="hidden" class="cate_id_hide" id="parent_id" name="id" />
        <input type="hidden" class="primaryKey" id="cate_id" name="cate_id" />
        <div class="row">
          <div class="col-md-12">
            <div class="clearfix">
              <p class="note pull-right">注：<span class="xing">*</span>标记为必填项</p>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label class="col-md-3 control-label" for="name"><span class="xing">*</span> 商品子分类名称：</label>
                  <div class="col-md-8">
                    <input type="text" id="name" name="name" class="form-control" placeholder="商品子分类名称" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-footer" style="text-align:center;">
    <button type="button" class="btn btn-success btn-sm save2">
      <span class="glyphicon glyphicon-save"></span> 保存
    </button>
    <button type="button" class="btn btn-default btn-sm layui-layer-close">
      <span class="glyphicon glyphicon-remove"></span> 取消
    </button>
  </div>
</div>

<!-- 隐藏域 -->
<form id="searchForm" name="searchForm" action="" style="position: fixed; top: 0; right: 0; z-index: 99999;">
  <input type="hidden" class="cate_id_hide" name="cate_id" value="" placeholder="产品分类：一级分类id" />
</form>
<!-- 文件树选择样式 隐藏域 -->
<input type="hidden" name="curSelectText" id="curSelectText" />

<include file="Public:footer_js" />

<!-- 文件树搜索 -->
<script type="text/javascript" src="/Public/dist/js/jquery.ztree.exhide.min.js"></script>

<script type="text/javascript">
// 表格数据
var $table    = $('#table_data');
var $g_params = {};
// table 功能设置
$table.bootstrapTable({
  toolbar:"#toolbar",                   // 工具栏
  toggle:"table",                       // 表格
  showToggle:true,                      // 是否显示(表格样式)切换
  showColumns:true,                     // 是否显示列(功能:[显示/隐藏]列)
  showExport:true,                      // 是否显示导出
  pagination:true,                      // 分页
  pageList:[10, 25, 50, 100],           // 每页行数
  ajax:"ajaxRequest",                   // 数据地址
  sidePagination:"server"               // 服务器
});

// 文件树
var settingLei = {
  edit: {
    enable: true,
    drag: {
      isCopy: false,
      isMove: false 
    }
  },
  data: {
    simpleData: {
      enable: true
    }
  },
  callback: {
    onClick: onClick,
    onRename: zTreeOnRename,
    beforeRemove: zTreeBeforeRemove,
    beforeRename: zTreeBeforeRename
  }
};
function onClick(event, treeId, treeNode) {
  if(treeNode) {
    $(".cate_id_hide").val(treeNode.id);
    for(var i=0; i<$(".node_name").length; i++) {
      if($(".node_name").eq(i).html() == $("#curSelectText").val()) {
        $(".node_name").eq(i).parent("a").removeClass('curSelectedNode');
      }
    }
    $("#curSelectText").val(treeNode.name);
    search();
  }
}
// 商品分类树选择样式处理
function curSelected() {
  var ids = $("#curSelectText").val();
  for(var i=0; i<$(".node_name").length; i++) {
    if($(".node_name").eq(i).html() == ids) {
      $(".node_name").eq(i).parents("a").addClass('curSelectedNode');
    }
  }
}
// 删除商品分类
function zTreeBeforeRemove(treeId, treeNode) {
  delGroup(treeNode.id,treeNode.name)
  return false;
}
// 编辑商品分类前处理
function zTreeBeforeRename(treeId, treeNode, newName, isCancel) {
  if (newName.length == 0) {
    dialog.error('商品分类名称不能为空！');
    return false;
  }
  for(var i=0; i<$(".node_name").length; i++) {
    if ($(".node_name").eq(i).html()  ==newName) {
      dialog.error('商品分类名称不能重复添加！');
      return false;
    }
  }
  return true;
}
// 编辑商品分类后处理
function zTreeOnRename(event, treeId, treeNode, isCancel) {
  for(var i=0; i<$(".node_name").length; i++) {
    if($(".node_name").eq(i).html() == $("#curSelectText").val()) {
      $(".node_name").eq(i).parent("a").removeClass('curSelectedNode');
    }
  }
  editLei(treeNode.id,treeNode.name);
}
// 请求商品分类树结构
function treeLei() {
  $.ajax({
    type: "get",
    url: "/index.php/Admin/Mall/Category/cateList",
    dataType: 'json', 
    success: function(msg) {
      var groupNodes = msg.data;
      $.fn.zTree.init($("#treeLei"), settingLei, groupNodes);
      curSelected();
    },
    error: function(msg) {
      dialog.error('请求服务器异常！');
    }
  })
}
treeLei();

// 编辑商品分类
function editLei(tid,text) {
  var ttid     = [tid];
  var strTid   = ttid.join(',');
  var data     = {};
  data.cate_id = strTid;
  data.name    = text;
  dialog.confirm('您确定要更改当前商品分类吗？',function(){fajax("/index.php/Admin/Mall/Category/cateEdit",data,refreshGroupCallBack,"post");});
  curSelected();
}

// 删除商品分类
function delGroup(tid) {
  var ttid     = [tid];
  var strTid   = ttid.join(',');
  var data     = {};
  data.cate_id = strTid;
  dialog.confirm('您确定要删除当前商品分类吗？',function(){fajax("/index.php/Admin/Mall/Category/cateDel",data,refreshGroupCallBack,"post");});
}

// 强刷提示功能
function refreshGroupCallBack(data) {
  if( data.code == 0 ) {
    dialog.error(data.info,function(){ window.location.reload(true);});
  } else {
    dialog.success(data.info,function(){ window.location.reload(true);});
  }
}

// 点击添加商品分类
$('.cate_add').click(function() {
  $('#cate_name').val('');
  layer.open({
    type: 1,
    title: '添加商品分类',
    shadeClose: true,
    shade: 0.2,
    area: ['60%', '60%'],
    content: $('#cate_modalWindow')
  });
})

// 点击添加子商品分类
$('.sub_cate_add').click(function() {
  $('.primaryKey').val('0');
  $('#name').val('');
  if ($('.cate_id_hide').val() == '') {
    dialog.error('请在左侧文件树先选择要添加子分类的商品分类！');
  } else {
    layer.open({
      type: 1,
      title: '添加子商品分类',
      shadeClose: true,
      shade: 0.2,
      area: ['60%', '60%'],
      content: $('#sub_cate_modalWindow')
    });
  };
})

// 保存商品分类数据
function save() {
  var url = g_config.host + '/index.php/Admin/Mall/Category/cateEdit';
  fpost(url,'cate_formWindow',refreshGroupCallBack);
}

// 自定义ajax请求
function ajaxRequest(params) {
  $g_params = params;
  // 需要的数据
  var url = "/index.php/Admin/Mall/Category/catesubList?" + $("#searchForm").serialize();
  queryList(url,params);
}

// 查询
function search() {
  // form查询域赋值
  var url = "/index.php/Admin/Mall/Category/catesubList?" + $("#searchForm").serialize();
  $g_params.data.page = parseInt($('.active .pagination li.active a').text());
  queryList(url,$g_params);
}

// 新增/编辑
function edit(id) {
  var url = g_config.host + '/index.php/Admin/Mall/Category/get';
  custom_edit(id,url,{cate_id:id},'sub_cate_formWindow','sub_cate_modalWindow');
}

// 保存数据
function save2() {
  if ($('#cate_id').val() > 0) {
    var url = g_config.host + '/index.php/Admin/Mall/Category/catesubEdit';
  } else {
    var url = g_config.host + '/index.php/Admin/Mall/Category/catesubAdd';
  };
  fpost(url,'sub_cate_formWindow',btnCallbackRefreshTable1);
}

// 删除
function del() {
  var url      = g_config.host + "/index.php/Admin/Mall/Category/catesubDel";
  var ids      = getIdSelections($('.js-custom-table-data'),'cate_id');
  var strIds   = ids.join(',');
  var data     = {};
  data.cate_id = strIds;

  if (ids.length == 0) {
    dialog.notify('请先选择要删除的记录');
    return;
  } else {
    dialog.confirm('您确定要删除当前选项吗？',function() {dpost(url,data,btnCallbackRefreshTable1);});
  }
}

// 左侧文件树搜索
$('#searchNodeBtn').click(function() {
  searchNodeAll('treeLei',$('#searchNodeVal'));
});
$('#searchNodeVal').on('input', function() {
  searchNodeAll('treeLei',$('#searchNodeVal'));
});
</script>
</body>
</html>
